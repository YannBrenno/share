<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Compartilhar resultado</title>

<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    background:#0f0f0f;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    gap:18px;
    text-align:center;
  }

  .box{
    background:#1b1b1b;
    padding:16px;
    border-radius:12px;
    width:95%;
    max-width:420px;
    box-shadow:0 0 15px #0008;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  img{
    max-width:100%;
    border-radius:10px;
  }

  .avatar{
    width:90px;
    height:90px;
    border-radius:50%;
    object-fit:cover;
    border:3px solid #0ea5a4;
  }

  button{
    padding:12px 20px;
    border-radius:10px;
    border:0;
    background:#0ea5a4;
    color:#022;
    font-weight:600;
    cursor:pointer;
    font-size:1rem;
  }

  button:disabled{
    background:#555;
    color:#999;
  }

  .notice{
    color:#ffc96b;
    font-size:.9rem;
  }

  #qrcodeWrapper {
    margin-top: 8px;
    background:#fff;
    padding:10px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #qrcodeImg { max-width:150px; }
  #qrcodeCanvas { display:none; }
</style>
</head>
<body>

  <h2>Resultado do Jogador</h2>

  <div id="info" class="notice"></div>

  <!-- QR code -->
  <div id="qrcodeWrapper">
    <img id="qrcodeImg" alt="QR Code" />
    <div id="qrcodeCanvas"></div>
  </div>

  <!-- Área de resultado -->
  <div class="box">
      <img id="avatar" class="avatar" style="display:none" />
      <img id="pic" alt="print" />
  </div>

  <div style="display:flex;gap:12px">
    <button id="shareBtn">Compartilhar</button>
    <button id="downloadBtn">Baixar</button>
  </div>

<!-- Lib para fallback do QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
(async function(){

  const info = document.getElementById('info');
  const pic = document.getElementById('pic');
  const avatar = document.getElementById('avatar');
  const qrcodeImg = document.getElementById('qrcodeImg');
  const qrcodeCanvas = document.getElementById('qrcodeCanvas');

  const params = new URLSearchParams(window.location.search);
  const player = params.get('player');

  const CURRENT_URL = window.location.href.split('#')[0];

  // -------------------------------
  // GERA QR CODE DA URL DA PÁGINA
  // -------------------------------
  function generateLocalQR(text) {
    qrcodeCanvas.innerHTML = "";
    new QRCode(qrcodeCanvas, {
      text,
      width: 150,
      height: 150,
      correctLevel: QRCode.CorrectLevel.M
    });
    qrcodeImg.style.display = 'none';
    qrcodeCanvas.style.display = 'block';
  }

  const remoteQR = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=` + encodeURIComponent(CURRENT_URL);
  qrcodeImg.src = remoteQR;

  qrcodeImg.onerror = () => generateLocalQR(CURRENT_URL);


  // ----------------------------------------
  // VALIDA PLAYER NA URL
  // ----------------------------------------
  if(!player){
    info.textContent = 'Erro: use ?player=NOME na URL.';
    pic.style.display = 'none';
    return;
  }

  info.textContent = 'Carregando dados de ' + player + '...';


  // ----------------------------------------
  // AUTO-RELOAD até carregar a imagem
  // ----------------------------------------
  let reloadTimer = setInterval(() => {
    console.log("Ainda sem imagem... recarregando.");
    location.reload();
  }, 3000);


  // ----------------------------------------
  // BUSCA DO FIREBASE
  // ----------------------------------------
  try{
    const resp = await fetch(
      `https://qajourneymultiplayer-default-rtdb.firebaseio.com/print/${encodeURIComponent(player)}.json`
    );

    const data = await resp.json();

    if(!data){
      info.textContent = 'Aguardando envio da imagem...';
      return;
    }

    // Print
    if(data.img){
      pic.src = data.img;
      clearInterval(reloadTimer);  // PARA o reload
    } else {
      pic.style.display = 'none';
    }

    // Avatar
    if(data.avatar){
      avatar.src = data.avatar;
      avatar.style.display = 'block';
    }

    info.textContent = 'Pronto! Você pode compartilhar abaixo.';

  }catch(e){
    info.textContent = 'Erro ao carregar dados: ' + e.message;
  }


  // ----------------------------------------
  // DOWNLOAD
  // ----------------------------------------
  document.getElementById('downloadBtn').onclick = () => {
    if(!pic.src) return;
    const a = document.createElement('a');
    a.href = pic.src;
    a.download = player + '-resultado.png';
    a.click();
  };


  // ----------------------------------------
  // COMPARTILHAR
  // ----------------------------------------
  document.getElementById('shareBtn').onclick = async () => {
    try{
      if(!pic.src) return alert('Sem imagem para compartilhar.');

      const r = await fetch(pic.src);
      const blob = await r.blob();
      const file = new File([blob], player + '-resultado.png', { type: blob.type });

      if(navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({
          files: [file],
          title: 'Meu resultado',
          text: 'Olha meu resultado no jogo!'
        });
      } else {
        alert('Seu navegador não suporta compartilhamento direto. Use Baixar.');
      }

    }catch(e){
      alert('Erro ao compartilhar: ' + e.message);
    }
  };

})();
</script>
</body>
</html>

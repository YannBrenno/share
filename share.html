<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Compartilhar resultado</title>
<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    background:#0f0f0f;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    gap:18px;
    text-align:center;
  }

  .box{
    background:#1b1b1b;
    padding:16px;
    border-radius:12px;
    width:95%;
    max-width:420px;
    box-shadow:0 0 15px #0008;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  img{
    max-width:100%;
    border-radius:10px;
  }

  .avatar{
    width:90px;
    height:90px;
    border-radius:50%;
    object-fit:cover;
    border:3px solid #0ea5a4;
  }

  button{
    padding:12px 20px;
    border-radius:10px;
    border:0;
    background:#0ea5a4;
    color:#022;
    font-weight:600;
    cursor:pointer;
    font-size:1rem;
  }

  button:disabled{
    background:#555;
    color:#999;
  }

  .notice{
    color:#ffc96b;
    font-size:.9rem;
  }

  #qrcodeWrapper {
    margin-top: 12px;
    background:#fff;
    padding:12px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #qrcodeImg { max-width:180px; }
  #qrcodeCanvas { display:none; }
</style>
</head>
<body>

  <h2>Resultado do Jogador</h2>

  <div id="info" class="notice"></div>

  <!-- QR CODE area: imagem + fallback canvas -->
  <div id="qrcodeWrapper" aria-hidden="false">
    <img id="qrcodeImg" alt="QR Code" />
    <div id="qrcodeCanvas"></div> <!-- fallback DOM target para qrcodejs -->
  </div>

  <div class="box">
      <img id="avatar" class="avatar" style="display:none" />
      <img id="pic" alt="print" />
  </div>

  <div style="display:flex;gap:12px">
    <button id="shareBtn">Compartilhar</button>
    <button id="downloadBtn">Baixar</button>
  </div>

<!-- qrcodejs fallback lib (apenas usada se a imagem externa falhar) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  // -------------------------
//   AUTO RELOAD A CADA 3s
// -------------------------
setInterval(() => location.reload(), 3000);
(async function(){

  const info = document.getElementById('info');
  const pic = document.getElementById('pic');
  const avatar = document.getElementById('avatar');
  const qrcodeImg = document.getElementById('qrcodeImg');
  const qrcodeCanvasTarget = document.getElementById('qrcodeCanvas');
  const qrcodeWrapper = document.getElementById('qrcodeWrapper');

  // monta a URL atual (sem fragmentos extras)
  const currentURL = window.location.href.split('#')[0];

  // Função para gerar QR localmente (fallback)
  function generateLocalQR(text, size = 180) {
    // limpa target
    qrcodeCanvasTarget.innerHTML = "";
    // usa qrcodejs para criar um <div> com o QR
    new QRCode(qrcodeCanvasTarget, {
      text: text,
      width: size,
      height: size,
      correctLevel: QRCode.CorrectLevel.M
    });
    // esconde a imagem externa e mostra o canvas/div gerado
    qrcodeImg.style.display = 'none';
    qrcodeCanvasTarget.style.display = 'block';
  }

  // Gera primeiro a URL do serviço confiável (api.qrserver.com)
  const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(currentURL);

  // tenta usar a imagem remota (rápido e sem JS)
  qrcodeImg.src = apiUrl;
  qrcodeImg.id = 'qrcodeImg';

  // se der erro ao carregar a imagem remota, gera localmente
  qrcodeImg.onerror = function() {
    console.warn('QR image load failed, generating local QR as fallback.');
    generateLocalQR(currentURL, 180);
  };

  // se carregar com sucesso, garante o canvas escondido
  qrcodeImg.onload = function() {
    qrcodeCanvasTarget.style.display = 'none';
    qrcodeImg.style.display = 'block';
  };

  // -------------------------
  //   BUSCA DO PLAYER
  // -------------------------
  const params = new URLSearchParams(window.location.search);
  const player = params.get('player');

  if(!player){
    info.textContent = 'Erro: use ?player=NOME na URL.';
    pic.style.display = 'none';
    return;
  }

  info.textContent = 'Carregando dados de ' + player + '...';

  try{
    const resp = await fetch(
      `https://qajourneymultiplayer-default-rtdb.firebaseio.com/print/${encodeURIComponent(player)}.json`
    );

    if(!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);

    const data = await resp.json();

    if(!data){
      info.textContent = 'Nenhum registro encontrado para "'+player+'".';
      pic.style.display = 'none';
      return;
    }

    // Imagem principal
    if(data.img){
      pic.src = data.img;
    } else {
      pic.style.display = 'none';
    }

    // Avatar
    if(data.avatar){
      avatar.src = data.avatar;
      avatar.style.display = 'block';
    }

    info.textContent = 'Pronto! Você pode compartilhar abaixo.';

  }catch(e){
    info.textContent = 'Erro ao carregar dados: ' + e.message;
    pic.style.display = 'none';
    return;
  }

  // -------------------------
  //   DOWNLOAD
  // -------------------------
  document.getElementById('downloadBtn').onclick = () => {
    if(!pic.src) return;
    const a = document.createElement('a');
    a.href = pic.src;
    a.download = player + '-resultado.png';
    a.click();
  };

  // -------------------------
  //   COMPARTILHAR
  // -------------------------
  document.getElementById('shareBtn').onclick = async () => {
    try{
      if(!pic.src) return alert('Sem imagem para compartilhar.');
      const r = await fetch(pic.src);
      const blob = await r.blob();
      const file = new File([blob], player + '-resultado.png', { type: blob.type });

      if(navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({
          files: [file],
          title: 'Meu resultado',
          text: 'Olha meu resultado no jogo!'
        });
      } else {
        alert('Seu navegador não suporta compartilhamento direto. Use Baixar.');
      }

    }catch(e){
      alert('Erro ao compartilhar: ' + e.message);
    }
  };

})();
</script>
</body>
</html>

